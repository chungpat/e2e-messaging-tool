<head>
    <link href="css/temp.css" rel="stylesheet">
    <link href="css/usability.css" rel="stylesheet">
    <script src="js/script_head.js"></script>

    </head>
    
    <p>
    <ul>
    <div class="dropdown">
      <li><a class="inactive" href="/home">Home</a></li>
      <li><a class="active" href="/lectures">Lecture Notes</a></li>
      <li><a class="inactive" href="/tutorials">Tutorial Content</a></li>
      <li><a class="inactive" href="/assignments">Assignment Work</a></li>
      <li><a class="inactive" href="/other">Other</a></li>
    </div>
    </ul>
    </p>
    <body>
        <div class="container">
            <h1>Document Download Page</h1>
        
            <div class="filter-section">
              <input type="text" id="search-input" placeholder="Search by name..." />
              <select id="sort-select">
                <option value="default">Sort by</option>
                <option value="name">Name (A-Z)</option>
                <option value="date">Date Uploaded</option>
              </select>

              <label for="password-filter-select">Password Filter:</label>
              <select id="password-filter-select">
                <option value="all">All</option>
                <option value="password">Password-Protected</option>
                <option value="no-password">No Password</option>
              </select>
            </div>
        
            <div id="document-list">
              <!-- Documents will be dynamically added here -->
            </div>
          </div>
      
          <script>
            // Function to fetch and display documents based on search and sort
            function fetchDocuments(searchValue, sortValue, passwordFilter) {
                const url = `/documents?search=${searchValue}&sort=${sortValue}&password=${passwordFilter}`;
                fetch(url)
                .then(response => response.json())
                .then(data => {
                    const documentList = document.getElementById('document-list');
                    documentList.innerHTML = ''; // Clear the previous document list

                    data.documents.forEach(async doc => {
                    const documentItem = document.createElement('div');
                    documentItem.classList.add('document-item');
                    documentItem.dataset.date = doc.date;
                    documentItem.innerHTML = `
                        <h3 class="document-title">${doc.name}</h3>
                        <p>Size: ${doc.size}mb</p>
                        <p>Filetype: ${doc.filetype}</p>
                        <p>Date Uploaded: ${doc.date}</p>
                        <button onclick="promptForPasswordAndDownload('${doc.path}', '${doc.password}')">Download</button>
                    `;
                    documentList.appendChild(documentItem);
                    });
                });
            }
            // Function to prompt for password and initiate download
            function promptForPasswordAndDownload(documentPath, passwordProtected) {
                if (!passwordProtected) {
                downloadDocument(documentPath);
                } else {
                const password = prompt('Enter password:');
                if (password !== null) {
                    const formData = new FormData();
                    formData.append('document_path', documentPath);
                    formData.append('password', password);
        
                    fetch('/download', {
                    method: 'POST',
                    body: formData
                    })
                    .then(response => {
                    if (response.ok) {
                        response.blob().then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = documentPath.split('/').pop();
                        link.click();
                        window.URL.revokeObjectURL(url);
                        });
                    } else {
                        promptForPasswordAndDownload(documentPath, true);
                    }
                    });
                }
                }
            }

            function downloadDocument(documentPath) {
                const link = document.createElement('a');
                link.href = documentPath;
                link.download = documentPath.split('/').pop();
                link.click();
              }

            // Event listener for search input
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                const searchValue = e.target.value.trim();
                const sortValue = document.getElementById('sort-select').value;
                fetchDocuments(searchValue, sortValue);
            });

            // Event listener for sort select
            const sortSelect = document.getElementById('sort-select');
            sortSelect.addEventListener('change', (e) => {
                const searchValue = document.getElementById('search-input').value.trim();
                const sortValue = e.target.value;
                fetchDocuments(searchValue, sortValue);
            });

              // Event listener for password filter select
            const passwordFilterSelect = document.getElementById('password-filter-select');
            passwordFilterSelect.addEventListener('change', (e) => {
                const searchValue = document.getElementById('search-input').value.trim();
                const sortValue = document.getElementById('sort-select').value;
                const passwordFilter = e.target.value;
                fetchDocuments(searchValue, sortValue, passwordFilter);
            });

            // Initial fetch to display all documents
            fetchDocuments('', '');
          </script>
      </body>